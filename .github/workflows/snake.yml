name: generate animation

env:
  DEFAULT_MODE: 'auto-hour'

on:
  # run automatically every 24 hours
  schedule:
    - cron: "0 * * * *"
    # - cron: "0 16 * * *"

  # allows to manually run the job at any time
  workflow_dispatch:
    inputs:
      mode:
        description: 'Color change mode'
        required: false
        type: choice
        options:
          - 'auto-day'
          - 'auto-hour'
          - 'manual'
        default: 'auto-hour'
      style:
        description: 'Manual color style (only used when mode is manual, 0-6 for weekday or 0-23 for hour)'
        required: false
        type: string
        default: ''

  # run on every push on the master branch
  push:
    branches:
    - master

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set color scheme by China time
        id: colors
        shell: python
        env:
          MODE: ${{ github.event.inputs.mode || env.DEFAULT_MODE }}
          MANUAL_STYLE: ${{ github.event.inputs.style || '' }}
          LIGHT_SCHEMAS_DAY: |
            [
              {"style":"海洋","snake":"#0277BD","dots":["#E1F5FE","#81D4FA","#4FC3F7","#29B6F6","#039BE5"]},
              {"style":"火焰","snake":"#E64A19","dots":["#FBE9E7","#FFAB91","#FF8A65","#FF7043","#FF5722"]},
              {"style":"森林","snake":"#28a745","dots":["#E8F5E9","#9be9a8","#40c463","#30a14e","#216e39"]},
              {"style":"科技","snake":"#5E35B1","dots":["#EDE7F6","#B39DDB","#9575CD","#7E57C2","#673AB7"]},
              {"style":"晨曦","snake":"#F57C00","dots":["#FFF8E1","#FFD54F","#FFCA28","#FFA000","#FF8F00"]},
              {"style":"樱花","snake":"#D81B60","dots":["#FCE4EC","#F48FB1","#F06292","#EC407A","#E91E63"]},
              {"style":"暮色","snake":"#5D4037","dots":["#EFEBE9","#BCAAA4","#A1887F","#8D6E63","#6D4C41"]}
            ]
          DARK_SCHEMAS_DAY: |
            [
              {"style":"深海","snake":"#00BCD4","dots":["#151b23","#004D56","#006B75","#00897B","#26C6DA"]},
              {"style":"熔岩","snake":"#FF6E40","dots":["#151b23","#5D1F0C","#8D2F10","#D84315","#FF7043"]},
              {"style":"丛林","snake":"#3FB950","dots":["#151b23","#033A16","#196C2E","#2EA043","#56D364"]},
              {"style":"赛博","snake":"#7C4DFF","dots":["#151b23","#311B92","#4527A0","#5E35B1","#9575CD"]},
              {"style":"琥珀","snake":"#FFB74D","dots":["#151b23","#E65100","#F57C00","#FF9800","#FFCA28"]},
              {"style":"玫瑰","snake":"#F06292","dots":["#151b23","#4A1229","#880E4F","#C2185B","#EC407A"]},
              {"style":"咖啡","snake":"#8D6E63","dots":["#151b23","#321911","#4E342E","#6D4C41","#A1887F"]}
            ]
          LIGHT_SCHEMAS_HOUR: |
            [
              {"style":"深夜紫","snake":"#4A148C","dots":["#EDE7F6","#9575CD","#7E57C2","#673AB7","#5E35B1"]},
              {"style":"午夜蓝","snake":"#01579B","dots":["#E1F5FE","#4FC3F7","#29B6F6","#039BE5","#0277BD"]},
              {"style":"寂静黑","snake":"#263238","dots":["#ECEFF1","#90A4AE","#607D8B","#546E7A","#455A64"]},
              {"style":"凌晨灰","snake":"#424242","dots":["#FAFAFA","#BDBDBD","#9E9E9E","#757575","#616161"]},
              {"style":"黎明粉","snake":"#C2185B","dots":["#FCE4EC","#F48FB1","#F06292","#EC407A","#E91E63"]},
              {"style":"晨曦橙","snake":"#E65100","dots":["#FFF3E0","#FFB74D","#FFA726","#FF9800","#FB8C00"]},
              {"style":"日出金","snake":"#F57F17","dots":["#FFFDE7","#FFF176","#FFEE58","#FFEB3B","#FDD835"]},
              {"style":"清晨黄","snake":"#F9A825","dots":["#FFFDE7","#FFF59D","#FFF176","#FFEE58","#FDD835"]},
              {"style":"上午绿","snake":"#2E7D32","dots":["#E8F5E9","#81C784","#66BB6A","#4CAF50","#43A047"]},
              {"style":"活力青","snake":"#00695C","dots":["#E0F2F1","#4DB6AC","#26A69A","#009688","#00897B"]},
              {"style":"正午蓝","snake":"#0277BD","dots":["#E1F5FE","#4FC3F7","#29B6F6","#03A9F4","#039BE5"]},
              {"style":"天空青","snake":"#0288D1","dots":["#E1F5FE","#4FC3F7","#29B6F6","#03A9F4","#039BE5"]},
              {"style":"午后蓝","snake":"#1976D2","dots":["#E3F2FD","#64B5F6","#42A5F5","#2196F3","#1E88E5"]},
              {"style":"温暖橙","snake":"#EF6C00","dots":["#FFF3E0","#FFB74D","#FFA726","#FF9800","#FB8C00"]},
              {"style":"夕阳红","snake":"#D84315","dots":["#FBE9E7","#FF8A65","#FF7043","#FF5722","#F4511E"]},
              {"style":"黄昏紫","snake":"#6A1B9A","dots":["#F3E5F5","#BA68C8","#AB47BC","#9C27B0","#8E24AA"]},
              {"style":"暮色粉","snake":"#AD1457","dots":["#FCE4EC","#F06292","#EC407A","#E91E63","#D81B60"]},
              {"style":"傍晚紫","snake":"#4527A0","dots":["#EDE7F6","#9575CD","#7E57C2","#673AB7","#5E35B1"]},
              {"style":"入夜蓝","snake":"#283593","dots":["#E8EAF6","#7986CB","#5C6BC0","#3F51B5","#3949AB"]},
              {"style":"夜幕紫","snake":"#311B92","dots":["#EDE7F6","#9575CD","#7E57C2","#673AB7","#5E35B1"]},
              {"style":"深夜靛","snake":"#1A237E","dots":["#E8EAF6","#7986CB","#5C6BC0","#3F51B5","#3949AB"]},
              {"style":"午夜蓝","snake":"#0D47A1","dots":["#E3F2FD","#64B5F6","#42A5F5","#2196F3","#1E88E5"]},
              {"style":"子夜黑","snake":"#212121","dots":["#F5F5F5","#BDBDBD","#9E9E9E","#757575","#616161"]},
              {"style":"静夜灰","snake":"#37474F","dots":["#ECEFF1","#90A4AE","#78909C","#607D8B","#546E7A"]}
            ]
          DARK_SCHEMAS_HOUR: |
            [
              {"style":"深夜紫","snake":"#7C4DFF","dots":["#151b23","#311B92","#4527A0","#5E35B1","#7E57C2"]},
              {"style":"午夜蓝","snake":"#00B0FF","dots":["#151b23","#01579B","#0277BD","#0288D1","#039BE5"]},
              {"style":"寂静黑","snake":"#546E7A","dots":["#151b23","#263238","#37474F","#455A64","#546E7A"]},
              {"style":"凌晨灰","snake":"#757575","dots":["#151b23","#424242","#616161","#757575","#9E9E9E"]},
              {"style":"黎明粉","snake":"#FF4081","dots":["#151b23","#880E4F","#AD1457","#C2185B","#D81B60"]},
              {"style":"晨曦橙","snake":"#FF6E40","dots":["#151b23","#BF360C","#D84315","#E64A19","#F4511E"]},
              {"style":"日出金","snake":"#FFD740","dots":["#151b23","#F57F17","#F9A825","#FBC02D","#FDD835"]},
              {"style":"清晨黄","snake":"#FFFF00","dots":["#151b23","#F57F17","#F9A825","#FBC02D","#FDD835"]},
              {"style":"上午绿","snake":"#69F0AE","dots":["#151b23","#1B5E20","#2E7D32","#388E3C","#43A047"]},
              {"style":"活力青","snake":"#64FFDA","dots":["#151b23","#004D40","#00695C","#00796B","#00897B"]},
              {"style":"正午蓝","snake":"#40C4FF","dots":["#151b23","#01579B","#0277BD","#0288D1","#039BE5"]},
              {"style":"天空青","snake":"#18FFFF","dots":["#151b23","#006064","#00838F","#0097A7","#00ACC1"]},
              {"style":"午后蓝","snake":"#448AFF","dots":["#151b23","#0D47A1","#1565C0","#1976D2","#1E88E5"]},
              {"style":"温暖橙","snake":"#FF9800","dots":["#151b23","#E65100","#EF6C00","#F57C00","#FB8C00"]},
              {"style":"夕阳红","snake":"#FF6E40","dots":["#151b23","#BF360C","#D84315","#E64A19","#F4511E"]},
              {"style":"黄昏紫","snake":"#E040FB","dots":["#151b23","#4A148C","#6A1B9A","#7B1FA2","#8E24AA"]},
              {"style":"暮色粉","snake":"#F50057","dots":["#151b23","#880E4F","#AD1457","#C2185B","#D81B60"]},
              {"style":"傍晚紫","snake":"#7C4DFF","dots":["#151b23","#311B92","#4527A0","#512DA8","#5E35B1"]},
              {"style":"入夜蓝","snake":"#536DFE","dots":["#151b23","#1A237E","#283593","#303F9F","#3949AB"]},
              {"style":"夜幕紫","snake":"#651FFF","dots":["#151b23","#311B92","#4527A0","#512DA8","#5E35B1"]},
              {"style":"深夜靛","snake":"#3D5AFE","dots":["#151b23","#1A237E","#283593","#303F9F","#3949AB"]},
              {"style":"午夜蓝","snake":"#2979FF","dots":["#151b23","#0D47A1","#1565C0","#1976D2","#1E88E5"]},
              {"style":"子夜黑","snake":"#616161","dots":["#151b23","#212121","#424242","#616161","#757575"]},
              {"style":"静夜灰","snake":"#78909C","dots":["#151b23","#263238","#37474F","#455A64","#546E7A"]}
            ]
        run: |
          import os, json
          from datetime import datetime
          from zoneinfo import ZoneInfo

          mode = os.environ.get('MODE', 'auto-hour')
          manual_style = os.environ.get('MANUAL_STYLE', '')
          now_china = datetime.now(ZoneInfo('Asia/Shanghai'))

          # Determine which mode to use
          if mode == 'manual' and manual_style:
              # Manual mode: user specifies the index
              idx = int(manual_style)
              # Determine if it's day or hour based on the index range
              if idx < 7:
                  light = json.loads(os.environ['LIGHT_SCHEMAS_DAY'])
                  dark = json.loads(os.environ['DARK_SCHEMAS_DAY'])
              else:
                  light = json.loads(os.environ['LIGHT_SCHEMAS_HOUR'])
                  dark = json.loads(os.environ['DARK_SCHEMAS_HOUR'])
                  idx = idx % 24  # Ensure it's in the valid range
          elif mode == 'auto-hour':
              # Hour mode: 24 color schemes based on hour
              idx = now_china.hour  # 0-23
              light = json.loads(os.environ['LIGHT_SCHEMAS_HOUR'])
              dark = json.loads(os.environ['DARK_SCHEMAS_HOUR'])
          else:
              # Day mode (default): 7 color schemes based on weekday
              idx = now_china.weekday()  # 0=Monday, 6=Sunday
              light = json.loads(os.environ['LIGHT_SCHEMAS_DAY'])
              dark = json.loads(os.environ['DARK_SCHEMAS_DAY'])

          entry_light = light[idx]
          entry_dark = dark[idx]

          light_snake = entry_light['snake'].strip()
          dark_snake = entry_dark['snake'].strip()
          light_dots = ', '.join([d.strip() for d in entry_light['dots']])
          dark_dots = ', '.join([d.strip() for d in entry_dark['dots']])

          out = os.environ.get('GITHUB_OUTPUT')
          if out:
              with open(out, 'a') as f:
                  f.write(f"light_color={light_snake}\n")
                  f.write(f"dark_color={dark_snake}\n")
                  f.write(f"light_dots={light_dots}\n")
                  f.write(f"dark_dots={dark_dots}\n")

      - name: Generate GitHub Contributions Snake Animations
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-snake-dark.svg?color_snake=${{ steps.colors.outputs.dark_color }}&color_dots=${{ steps.colors.outputs.dark_dots }}
            dist/github-snake.svg?color_snake=${{ steps.colors.outputs.light_color }}&color_dots=${{ steps.colors.outputs.light_dots }}

      # push the content of <build_dir> to a branch
      # the content will be available at https://raw.githubusercontent.com/<github_user>/<repository>/<target_branch>/<file> , or as github page
      - name: push github-snake.svg to the output branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          commit_message: "Update snake animation [skip ci]"
