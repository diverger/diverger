name: generate animation

on:
  # run automatically every 24 hours
  schedule:
    - cron: "0 16 * * *"

  # allows to manually run the job at any time
  workflow_dispatch:

  # run on every push on the master branch
  push:
    branches:
    - master

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set color scheme by China weekday
        id: colors
        shell: python
        env:
          LIGHT_SCHEMAS: |
            [
              {"style":"海洋","snake":"#0097A7","dots":["#E0F7FA","#B2EBF2","#80DEEA","#4DD0E1","#26C6DA"]},
              {"style":"火焰","snake":"#F4511E","dots":["#FBE9E7","#FFCCBC","#FFAB91","#FF8A65","#FF7043"]},
              {"style":"森林","snake":"#689F38","dots":["#F1F8E9","#DCEDC8","#C5E1A5","#AED581","#9CCC65"]},
              {"style":"科技","snake":"#5E35B1","dots":["#EDE7F6","#D1C4E9","#B39DDB","#9575CD","#7E57C2"]},
              {"style":"晨曦","snake":"#FFA000","dots":["#FFF8E1","#FFECB3","#FFE082","#FFD54F","#FFCA28"]},
              {"style":"樱花","snake":"#EC407A","dots":["#FCE4EC","#F8BBD0","#F48FB1","#F06292","#EC407A"]},
              {"style":"暮色","snake":"#5D4037","dots":["#EFEBE9","#D7CCC8","#BCAAA4","#A1887F","#8D6E63"]}
            ]
          DARK_SCHEMAS: |
            [
              {"style":"深海","snake":"#006064","dots":["#004B54","#005A63","#006D76","#00838F","#17A1A8"]},
              {"style":"熔岩","snake":"#BF360C","dots":["#5A1F12","#7A2A14","#9A3415","#B73C15","#D84315"]},
              {"style":"丛林","snake":"#2E7D32","dots":["#1F5A22","#256428","#2E7D32","#3A8F3A","#4CAF50"]},
              {"style":"赛博","snake":"#512DA8","dots":["#2A1F62","#3A2B78","#4A3690","#5B40A6","#6A48B9"]},
              {"style":"琥珀","snake":"#FF6F00","dots":["#734300","#8C5400","#A66400","#C97800","#FF8F00"]},
              {"style":"玫瑰","snake":"#880E4F","dots":["#5A1535","#6E1A42","#7F1E4C","#931C55","#AD1457"]},
              {"style":"咖啡","snake":"#3E2723","dots":["#2F211F","#3A2A26","#44312C","#4D382F","#5D4037"]}
            ]

        run: |
          import os, json
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now_china = datetime.now(ZoneInfo('Asia/Shanghai'))
          py_weekday = now_china.weekday()
          sun_idx = (py_weekday + 1) % 7

          light = json.loads(os.environ['LIGHT_SCHEMAS'])
          dark = json.loads(os.environ['DARK_SCHEMAS'])
          entry_light = light[sun_idx]
          entry_dark = dark[sun_idx]

          light_snake = entry_light['snake'].strip()
          dark_snake = entry_dark['snake'].strip()
          light_dots = ', '.join([d.strip() for d in entry_light['dots']])
          dark_dots = ', '.join([d.strip() for d in entry_dark['dots']])

          out = os.environ.get('GITHUB_OUTPUT')
          if out:
              with open(out, 'a') as f:
                  f.write(f"light_color={light_snake}\n")
                  f.write(f"dark_color={dark_snake}\n")
                  f.write(f"light_dots={light_dots}\n")
                  f.write(f"dark_dots={dark_dots}\n")

      - name: Generate GitHub Contributions Snake Animations
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-snake-dark.svg?color_snake=${{ steps.colors.outputs.dark_color }}&color_dots=${{ steps.colors.outputs.dark_dots }}
            dist/github-snake.svg?color_snake=${{ steps.colors.outputs.light_color }}&color_dots=${{ steps.colors.outputs.light_dots }}

      # push the content of <build_dir> to a branch
      # the content will be available at https://raw.githubusercontent.com/<github_user>/<repository>/<target_branch>/<file> , or as github page
      - name: push github-snake.svg to the output branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          commit_message: "Update snake animation [skip ci]"
