name: generate animation

on:
  # run automatically every 24 hours
  schedule:
    - cron: "0 16 * * *"

  # allows to manually run the job at any time
  workflow_dispatch:

  # run on every push on the master branch
  push:
    branches:
    - master

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set color scheme by CST weekday
        id: colors
        shell: python
        env:
          LIGHT_SCHEMAS: |
            [
              {"style":"清新","snake":"#00897B","dots":["#e0f7f4","#b2f2e9","#80eccc","#4bd6b3","#00bfa5"]},
              {"style":"夕阳","snake":"#FF7043","dots":["#fff3e0","#ffe0b2","#ffcc80","#ffb74d","#ff8a65"]},
              {"style":"怀旧","snake":"#B57C4D","dots":["#fbf3ea","#f2dfc9","#e6c79f","#d2a879","#b57c4d"]},
              {"style":"未来","snake":"#2196F3","dots":["#e1f5fe","#b3e5fc","#81d4fa","#4fc3f7","#03a9f4"]},
              {"style":"温暖","snake":"#FFB300","dots":["#fff8e1","#ffecb3","#ffe082","#ffd54f","#ffb300"]},
              {"style":"浪漫","snake":"#D81B60","dots":["#fce4ec","#f8bbd0","#f48fb1","#f06292","#d81b60"]},
              {"style":"梦幻","snake":"#AB47BC","dots":["#f3e5f5","#e1bee7","#ce93d8","#ba68c8","#ab47bc"]}
            ]
          DARK_SCHEMAS: |
            [
              {"style":"清新","snake":"#00796B","dots":["#c8f7f1","#9fefe6","#6ee5d7","#42d4c8","#00bfa5"]},
              {"style":"夕阳","snake":"#D24C13","dots":["#fff0d6","#ffd2a8","#ffb57a","#ff944f","#d24c13"]},
              {"style":"怀旧","snake":"#7A4B2A","dots":["#f6e9df","#e6ccb3","#d2ab88","#b88759","#7a4b2a"]},
              {"style":"未来","snake":"#0066CC","dots":["#dff3ff","#bfe9ff","#8fdaff","#59caff","#0066cc"]},
              {"style":"温暖","snake":"#8B5E3C","dots":["#fff6e0","#ffe8bf","#ffd89e","#ffc27a","#8b5e3c"]},
              {"style":"朋克","snake":"#8B1D78","dots":["#f7dbe9","#efb6d6","#e887c6","#dd4aa9","#8b1d78"]},
              {"style":"复古","snake":"#6A2C91","dots":["#f1e6fb","#e0c9f5","#ccaef0","#b08ae8","#6a2c91"]}
            ]
        run: |
          import os, json
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now_cst = datetime.now(ZoneInfo('America/Chicago'))
          py_weekday = now_cst.weekday()
          sun_idx = (py_weekday + 1) % 7

          light = json.loads(os.environ['LIGHT_SCHEMAS'])
          dark = json.loads(os.environ['DARK_SCHEMAS'])
          entry_light = light[sun_idx]
          entry_dark = dark[sun_idx]

          light_snake = entry_light['snake'].strip()
          dark_snake = entry_dark['snake'].strip()
          light_dots = ', '.join([d.strip() for d in entry_light['dots']])
          dark_dots = ', '.join([d.strip() for d in entry_dark['dots']])

          out = os.environ.get('GITHUB_OUTPUT')
          if out:
              with open(out, 'a') as f:
                  f.write(f"light_color={light_snake}\n")
                  f.write(f"dark_color={dark_snake}\n")
                  f.write(f"light_dots={light_dots}\n")
                  f.write(f"dark_dots={dark_dots}\n")

      - name: Generate GitHub Contributions Snake Animations
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-snake-dark.svg?color_snake=${{ steps.colors.outputs.dark_color }}&color_dots=${{ steps.colors.outputs.dark_dots }}
            dist/github-snake.svg?color_snake=${{ steps.colors.outputs.light_color }}&color_dots=${{ steps.colors.outputs.light_dots }}

      # push the content of <build_dir> to a branch
      # the content will be available at https://raw.githubusercontent.com/<github_user>/<repository>/<target_branch>/<file> , or as github page
      - name: push github-snake.svg to the output branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          commit_message: "Update snake animation [skip ci]"
