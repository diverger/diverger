name: generate animation

on:
  # run automatically every 24 hours
  schedule:
    - cron: "0 16 * * *"

  # allows to manually run the job at any time
  workflow_dispatch:

  # run on every push on the master branch
  push:
    branches:
    - master

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set color scheme by China weekday
        id: colors
        shell: python
        env:
          LIGHT_SCHEMAS: |
            [
              {"style":"清新","snake":"#26A69A","dots":["#E0F2F1","#B2DFDB","#80CBC4","#4DB6AC","#26A69A"]},
              {"style":"夕阳","snake":"#FF7043","dots":["#FBE9E7","#FFCCBC","#FFAB91","#FF8A65","#FF7043"]},
              {"style":"怀旧","snake":"#A1887F","dots":["#EFEBE9","#D7CCC8","#BCAAA4","#A1887F","#8D6E63"]},
              {"style":"未来","snake":"#42A5F5","dots":["#E3F2FD","#BBDEFB","#90CAF9","#64B5F6","#42A5F5"]},
              {"style":"金秋","snake":"#FFA726","dots":["#FFF3E0","#FFE0B2","#FFCC80","#FFB74D","#FFA726"]},
              {"style":"浪漫","snake":"#EC407A","dots":["#FCE4EC","#F8BBD0","#F48FB1","#F06292","#EC407A"]},
              {"style":"梦幻","snake":"#AB47BC","dots":["#F3E5F5","#E1BEE7","#CE93D8","#BA68C8","#AB47BC"]}
            ]
          DARK_SCHEMAS: |
            [
              {"style":"清新","snake":"#00897B","dots":["#B2DFDB","#80CBC4","#4DB6AC","#26A69A","#00897B"]},
              {"style":"夕阳","snake":"#E64A19","dots":["#FFCCBC","#FFAB91","#FF8A65","#FF7043","#E64A19"]},
              {"style":"怀旧","snake":"#6D4C41","dots":["#D7CCC8","#BCAAA4","#A1887F","#8D6E63","#6D4C41"]},
              {"style":"未来","snake":"#1976D2","dots":["#BBDEFB","#90CAF9","#64B5F6","#42A5F5","#1976D2"]},
              {"style":"金秋","snake":"#F57C00","dots":["#FFE0B2","#FFCC80","#FFB74D","#FFA726","#F57C00"]},
              {"style":"朋克","snake":"#C2185B","dots":["#F8BBD0","#F48FB1","#F06292","#EC407A","#C2185B"]},
              {"style":"复古","snake":"#7B1FA2","dots":["#E1BEE7","#CE93D8","#BA68C8","#AB47BC","#7B1FA2"]}
            ]

        run: |
          import os, json
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now_china = datetime.now(ZoneInfo('Asia/Shanghai'))
          py_weekday = now_china.weekday()
          sun_idx = (py_weekday + 1) % 7

          light = json.loads(os.environ['LIGHT_SCHEMAS'])
          dark = json.loads(os.environ['DARK_SCHEMAS'])
          entry_light = light[sun_idx]
          entry_dark = dark[sun_idx]

          light_snake = entry_light['snake'].strip()
          dark_snake = entry_dark['snake'].strip()
          light_dots = ', '.join([d.strip() for d in entry_light['dots']])
          dark_dots = ', '.join([d.strip() for d in entry_dark['dots']])

          out = os.environ.get('GITHUB_OUTPUT')
          if out:
              with open(out, 'a') as f:
                  f.write(f"light_color={light_snake}\n")
                  f.write(f"dark_color={dark_snake}\n")
                  f.write(f"light_dots={light_dots}\n")
                  f.write(f"dark_dots={dark_dots}\n")

      - name: Generate GitHub Contributions Snake Animations
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-snake-dark.svg?color_snake=${{ steps.colors.outputs.dark_color }}&color_dots=${{ steps.colors.outputs.dark_dots }}
            dist/github-snake.svg?color_snake=${{ steps.colors.outputs.light_color }}&color_dots=${{ steps.colors.outputs.light_dots }}

      # push the content of <build_dir> to a branch
      # the content will be available at https://raw.githubusercontent.com/<github_user>/<repository>/<target_branch>/<file> , or as github page
      - name: push github-snake.svg to the output branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          commit_message: "Update snake animation [skip ci]"
